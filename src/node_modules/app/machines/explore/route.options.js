import {actions, assign} from 'xstate';

import DATASETS from 'app/data/datasets.json';
import {stringifyContextStores} from 'app/machines/utils';
import {getSearchURL} from 'app/utils/specs';

const {log} = actions;

export const makeDatasetId =
	({project, source, version}) => `${project}_${source}_v${version}`;

const selectDataset = (ctx, {project, source, version}) => {
	ctx.dataset.set({project, source, version});

	const datasetId = makeDatasetId({project, source, version});
	const dataset = DATASETS.find(ds => ds.id === datasetId);
	const queryURL = getSearchURL(dataset);
	ctx.queryURL.set(queryURL);

	return ctx;
}

export const routeOptions = {
	actions: {
		logEvent: log(
			(context, event) => `---- context: ${stringifyContextStores(context)}\n\n---- event: ${JSON.stringify(event)}`,
			'logEvent'
		),
		selectDataset: assign(selectDataset),
	},
	guards: {}
};
